---
# Hardware Detection - Auto-detect GPU, CPU, and SMBIOS

- name: Detect GPU information
  shell: lspci -nn | grep -iE "vga|3d controller" | head -1
  register: gpu_detect
  changed_when: false
  failed_when: gpu_detect.stdout == ""

- name: Parse GPU PCI address
  set_fact:
    detected_gpu_pci: "{{ gpu_detect.stdout.split()[0] }}"
    detected_gpu_vendor: "{{ 'NVIDIA' if 'nvidia' in gpu_detect.stdout.lower() else 'AMD' }}"

- name: Check for GPU audio device
  shell: lspci -s {{ detected_gpu_pci[:-1] }}1
  register: gpu_audio_check
  changed_when: false
  failed_when: false

- name: Set GPU audio PCI if exists
  set_fact:
    detected_gpu_audio_pci: "{{ detected_gpu_pci[:-1] }}1"
  when: gpu_audio_check.rc == 0

- name: Display detected GPU
  debug:
    msg:
      - "GPU Detected: {{ detected_gpu_vendor }}"
      - "Video PCI: {{ detected_gpu_pci }}"
      - "Audio PCI: {{ detected_gpu_audio_pci | default('Not found') }}"

- name: Detect CPU vendor
  set_fact:
    detected_cpu_vendor: "{{ 'AMD' if 'AuthenticAMD' in ansible_processor[0] else 'Intel' }}"
    detected_cpu_cores: "{{ ansible_processor_vcpus }}"

- name: Display detected CPU
  debug:
    msg:
      - "CPU: {{ ansible_processor[0] }}"
      - "Vendor: {{ detected_cpu_vendor }}"
      - "Cores: {{ detected_cpu_cores }}"

- name: Load pre-scanned hardware information
  include_vars:
    file: /tmp/vfio_hardware_prescan.yml
    name: prescan

- name: Parse BIOS information from prescan
  set_fact:
    bios_info:
      vendor: "{{ prescan.bios_vendor }}"
      version: "{{ prescan.bios_version }}"
      date: "{{ prescan.bios_date }}"

- name: Parse System information from prescan
  set_fact:
    system_info:
      manufacturer: "{{ prescan.system_manufacturer }}"
      product: "{{ prescan.system_product }}"
      version: "{{ prescan.system_version }}"
      serial: "{{ prescan.system_serial }}"
      uuid: "{{ prescan.system_uuid }}"
      family: "{{ prescan.system_family }}"

- name: Parse Baseboard information from prescan
  set_fact:
    baseboard_info:
      manufacturer: "{{ prescan.baseboard_manufacturer }}"
      product: "{{ prescan.baseboard_product }}"
      version: "{{ prescan.baseboard_version }}"
      serial: "{{ prescan.baseboard_serial }}"
      asset: "{{ prescan.baseboard_asset }}"

- name: Save hardware detection results
  copy:
    dest: "/tmp/vfio_detected_hardware.yml"
    content: |
      # Auto-detected hardware configuration
      # Generated: {{ ansible_date_time.iso8601 }}

      gpu_pci_video: "0000:{{ detected_gpu_pci }}"
      gpu_pci_audio: "0000:{{ detected_gpu_audio_pci | default('none') }}"
      cpu_vendor: "{{ detected_cpu_vendor }}"
      cpu_cores: {{ detected_cpu_cores }}

      # SMBIOS Information
      smbios_bios_vendor: "{{ bios_info.vendor }}"
      smbios_bios_version: "{{ bios_info.version }}"
      smbios_bios_date: "{{ bios_info.date | trim | regex_replace('/\\d\\d(\\d\\d)$', '/\\1') }}"

      smbios_system_manufacturer: "{{ system_info.manufacturer }}"
      smbios_system_product: "{{ system_info.product }}"
      smbios_system_version: "{{ system_info.version }}"
      smbios_system_serial: "{{ system_info.serial }}"
      smbios_system_uuid: "{{ system_info.uuid }}"
      smbios_system_family: "{{ system_info.family }}"

      smbios_baseboard_manufacturer: "{{ baseboard_info.manufacturer }}"
      smbios_baseboard_product: "{{ baseboard_info.product }}"
      smbios_baseboard_version: "{{ baseboard_info.version }}"
      smbios_baseboard_serial: "{{ baseboard_info.serial }}"
      smbios_baseboard_asset: "{{ baseboard_info.asset }}"
    mode: '0644'
