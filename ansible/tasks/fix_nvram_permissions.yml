---
# Fix NVRAM Permissions - Resolve "Permission denied" errors for NVRAM files

- name: Detect libvirt connection type
  shell: |
    if virsh uri 2>/dev/null | grep -q 'qemu:///session'; then
      echo "session"
    else
      echo "system"
    fi
  register: libvirt_connection_type
  changed_when: false
  failed_when: false
  become: false

- name: Set NVRAM directory based on connection type
  set_fact:
    nvram_dir: "{{ lookup('env', 'HOME') }}/.local/share/libvirt/qemu/nvram"
  when: libvirt_connection_type.stdout == "session"

- name: Set NVRAM directory for system mode
  set_fact:
    nvram_dir: "/var/lib/libvirt/qemu/nvram"
  when: libvirt_connection_type.stdout == "system"

- name: Display detected libvirt mode
  debug:
    msg: "Detected libvirt mode: {{ libvirt_connection_type.stdout }}, NVRAM directory: {{ nvram_dir }}"

- name: Create NVRAM directory if it doesn't exist (session mode)
  file:
    path: "{{ nvram_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
  become: false
  when:
    - nvram_dir is defined
    - libvirt_connection_type.stdout == "session"

- name: Recommend creating NVRAM directory (system mode)
  debug:
    msg:
      - "System mode detected. NVRAM directory may need manual creation:"
      - "  sudo mkdir -p {{ nvram_dir }}"
      - "  sudo chown root:root {{ nvram_dir }}"
  when:
    - nvram_dir is defined
    - libvirt_connection_type.stdout == "system"

- name: Check if NVRAM file exists
  stat:
    path: "{{ nvram_dir }}/{{ vm_name }}_VARS.fd"
  register: nvram_file
  when: nvram_dir is defined

- name: Fix NVRAM file permissions (session mode)
  file:
    path: "{{ nvram_dir }}/{{ vm_name }}_VARS.fd"
    mode: '0600'
    owner: "{{ ansible_user_id }}"
  become: false
  when:
    - nvram_dir is defined
    - nvram_file.stat.exists
    - libvirt_connection_type.stdout == "session"

- name: Recommend fixing NVRAM file permissions (system mode)
  debug:
    msg:
      - "System mode NVRAM file detected. You may need to fix permissions manually:"
      - "  sudo chmod 644 {{ nvram_dir }}/{{ vm_name }}_VARS.fd"
      - "  sudo chown root:root {{ nvram_dir }}/{{ vm_name }}_VARS.fd"
  when:
    - nvram_dir is defined
    - nvram_file.stat.exists
    - libvirt_connection_type.stdout == "system"

- name: Fix parent directory ownership (session mode)
  file:
    path: "{{ nvram_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    recurse: false
  become: false
  when: libvirt_connection_type.stdout == "session"

- name: Recommend ACL setup (system mode)
  debug:
    msg:
      - "For system mode, you may need to set ACLs for qemu user access:"
      - "  QEMU_USER=$(id -u qemu 2>/dev/null || id -u libvirt-qemu 2>/dev/null)"
      - "  sudo setfacl -m u:${QEMU_USER}:rw {{ nvram_dir }}/{{ vm_name }}_VARS.fd"
      - ""
      - "This is optional and usually not needed for session mode."
  when:
    - libvirt_connection_type.stdout == "system"
    - nvram_file.stat.exists

- name: Display NVRAM permission fix status
  debug:
    msg:
      - "✓ NVRAM directory: {{ nvram_dir }}"
      - "✓ Connection mode: {{ libvirt_connection_type.stdout }}"
      - "{{ '✓ NVRAM file permissions fixed' if nvram_file.stat.exists else '⚠ NVRAM file will be created on first VM start' }}"
