---
# Start VM - Launch VM and virt-manager

- name: Start the VM
  shell: virsh start {{ vm_name }} 2>&1
  register: vm_start
  failed_when: false
  changed_when: vm_start.rc == 0

- name: Check for NVRAM permission error
  set_fact:
    nvram_permission_error: "{{ 'Permission denied' in vm_start.stderr and 'nvram' in vm_start.stderr.lower() }}"
  when: vm_start.rc != 0

- name: Check for storage file access error
  set_fact:
    storage_permission_error: "{{ 'Cannot access storage file' in vm_start.stderr or ('Permission denied' in vm_start.stderr and 'qcow2' in vm_start.stderr) }}"
  when: vm_start.rc != 0

- name: Display storage permission fix instructions
  debug:
    msg:
      - "╔════════════════════════════════════════════════════════════╗"
      - "║  STORAGE FILE PERMISSION ERROR                            ║"
      - "╚════════════════════════════════════════════════════════════╝"
      - ""
      - "libvirt-qemu cannot access your disk files in ~/libvirt/images/"
      - ""
      - "Quick Fix Option 1: Set proper group ownership (RECOMMENDED)"
      - "  Run these commands to fix permissions:"
      - "  cd ~/libvirt"
      - "  chgrp -R kvm ."
      - "  chmod -R g+w images/"
      - "  chmod g+x ."
      - ""
      - "Quick Fix Option 2: Use system storage location"
      - "  Move disk to system location:"
      - "  sudo mkdir -p /var/lib/libvirt/images"
      - "  sudo mv ~/libvirt/images/*.qcow2 /var/lib/libvirt/images/"
      - "  Update VM XML to point to new location"
      - ""
      - "Quick Fix Option 3: Set ACLs (most flexible)"
      - "  sudo setfacl -m u:libvirt-qemu:rx ~/libvirt"
      - "  sudo setfacl -m u:libvirt-qemu:rwx ~/libvirt/images"
      - ""
      - "After applying fix, retry: virsh start {{ vm_name }}"
  when: vm_start.rc != 0 and storage_permission_error | default(false)

- name: Auto-fix NVRAM permissions if detected
  include_tasks: fix_nvram_permissions.yml
  when: vm_start.rc != 0 and nvram_permission_error | default(false)

- name: Retry VM start after permission fix
  shell: virsh start {{ vm_name }}
  register: vm_start_retry
  failed_when: false
  changed_when: vm_start_retry.rc == 0
  when: vm_start.rc != 0 and nvram_permission_error | default(false)

- name: Check VM state
  shell: virsh list | grep {{ vm_name }}
  register: vm_state
  changed_when: false
  failed_when: false

- name: Determine if VM is running
  set_fact:
    vm_is_running: "{{ vm_state.rc == 0 and 'running' in vm_state.stdout }}"

- name: Display VM start status (success)
  debug:
    msg:
      - "✓ VM started successfully"
      - "✓ Connect with: virt-manager"
      - "✓ Or use: virsh console {{ vm_name }}"
  when: vm_is_running

- name: Display VM start error with helpful message
  debug:
    msg:
      - "⚠ Failed to start VM"
      - "Error: {{ vm_start.stderr | default(vm_start.stdout) | default('Unknown error') }}"
      - ""
      - "Troubleshooting steps:"
      - "  1. Check libvirt logs: journalctl -u libvirtd -f"
      - "  2. Verify VM definition: virsh dumpxml {{ vm_name }}"
      - "  3. Check IOMMU groups: dmesg | grep -i iommu"
      - "  4. Ensure GPU is not in use: lsof /dev/nvidia* /dev/dri/*"
  when: not vm_is_running

- name: Launch virt-manager
  shell: |
    sudo -u {{ lookup('env', 'SUDO_USER') | default(ansible_user_id) }} \
    DISPLAY={{ lookup('env', 'DISPLAY') | default(':0') }} \
    virt-manager &
  async: 10
  poll: 0
  when: vm_is_running and lookup('env', 'DISPLAY') != ''
