---
# Install VFIO - Setup libraries, scripts, and hooks

- name: Create VFIO directories (user-owned)
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ install_dir }}"
    - "{{ install_dir }}/lib"
    - "{{ install_dir }}/scripts"
    - "{{ install_dir }}/config"
  become: false

- name: Check if VFIO library exists
  stat:
    path: "{{ project_root }}/lib/vfio-common.sh"
  register: vfio_lib

- name: Copy VFIO library
  copy:
    src: "{{ project_root }}/lib/vfio-common.sh"
    dest: "{{ install_dir }}/lib/vfio-common.sh"
    mode: '0755'
  when: vfio_lib.stat.exists

- name: Copy VFIO scripts
  copy:
    src: "{{ item }}"
    dest: "{{ install_dir }}/scripts/{{ item | basename }}"
    mode: '0755'
  loop:
    - "{{ project_root }}/scripts/vfio-start"
    - "{{ project_root }}/scripts/vfio-stop"
  ignore_errors: true

- name: Display hook installation info
  debug:
    msg:
      - "Note: Libvirt hooks and systemd services require sudo to install"
      - "To install manually:"
      - "  sudo cp hooks/qemu.new /etc/libvirt/hooks/qemu"
      - "  sudo chmod +x /etc/libvirt/hooks/qemu"
      - "These are optional and can be installed later if needed"
