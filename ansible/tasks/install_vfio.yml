---
# Install VFIO - Setup libraries, scripts, and hooks

- name: Create VFIO directories (user-owned)
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ install_dir }}"
    - "{{ install_dir }}/lib"
    - "{{ install_dir }}/scripts"
    - "{{ install_dir }}/config"
  become: false

- name: Check if libvirt hooks directory exists
  stat:
    path: /etc/libvirt/hooks
  register: hooks_dir
  become: false

- name: Recommend creating libvirt hooks directory
  debug:
    msg:
      - "Libvirt hooks directory not found. Please create it manually:"
      - "  sudo mkdir -p /etc/libvirt/hooks /var/log/libvirt"
      - "  sudo chmod 755 /etc/libvirt/hooks /var/log/libvirt"
      - ""
      - "This is required for VFIO GPU binding/unbinding during VM start/stop."
  when: not hooks_dir.stat.exists

- name: Copy VFIO library
  copy:
    src: "{{ project_root }}/lib/vfio-common.sh"
    dest: "{{ install_dir }}/lib/vfio-common.sh"
    mode: '0755'
  become: false

- name: Copy VFIO scripts
  copy:
    src: "{{ item }}"
    dest: "{{ install_dir }}/scripts/{{ item | basename }}"
    mode: '0755'
  loop:
    - "{{ project_root }}/scripts/vfio-start"
    - "{{ project_root }}/scripts/vfio-stop"
  become: false

- name: Check if libvirt hook exists
  stat:
    path: /etc/libvirt/hooks/qemu
  register: hook_exists
  become: false

- name: Copy hook template to user directory
  copy:
    src: "{{ project_root }}/hooks/qemu.new"
    dest: "{{ install_dir }}/qemu.hook"
    mode: '0755'
  when: not hook_exists.stat.exists
  become: false

- name: Configure hook template with install directory
  lineinfile:
    path: "{{ install_dir }}/qemu.hook"
    regexp: '^PROJECT_ROOT='
    line: 'PROJECT_ROOT="{{ install_dir }}"'
    insertafter: '# Determine project root'
  when: not hook_exists.stat.exists
  become: false

- name: Recommend installing libvirt hook
  debug:
    msg:
      - "Libvirt hook needs to be installed. Please run:"
      - "  sudo cp {{ install_dir }}/qemu.hook /etc/libvirt/hooks/qemu"
      - "  sudo chmod 755 /etc/libvirt/hooks/qemu"
      - "  sudo systemctl restart libvirtd"
      - ""
      - "This hook handles VFIO GPU binding/unbinding when the VM starts/stops."
  when: not hook_exists.stat.exists

- name: Display hook status
  debug:
    msg: "✓ Libvirt hook already installed at /etc/libvirt/hooks/qemu"
  when: hook_exists.stat.exists

- name: Check if libvirt-nosleep service exists
  stat:
    path: /etc/systemd/system/libvirt-nosleep@.service
  register: nosleep_exists
  become: false

- name: Create libvirt-nosleep service template
  copy:
    dest: "{{ install_dir }}/libvirt-nosleep@.service"
    content: |
      [Unit]
      Description=Preventing sleep while libvirt domain "%i" is running

      [Service]
      Type=simple
      ExecStart=/usr/bin/systemd-inhibit --what=sleep --why="Libvirt domain %i is running" --who=%U --mode=block sleep infinity
    mode: '0644'
  when: not nosleep_exists.stat.exists
  become: false

- name: Recommend installing nosleep service
  debug:
    msg:
      - "libvirt-nosleep service needs to be installed. Please run:"
      - "  sudo cp {{ install_dir }}/libvirt-nosleep@.service /etc/systemd/system/"
      - "  sudo systemctl daemon-reload"
      - ""
      - "This service prevents the host from sleeping while the VM is running."
      - "It's optional but recommended for uninterrupted VM operation."
  when: not nosleep_exists.stat.exists

- name: Display nosleep service status
  debug:
    msg: "✓ libvirt-nosleep service already installed"
  when: nosleep_exists.stat.exists
