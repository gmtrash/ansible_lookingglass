---
# Install VFIO - Setup libraries, scripts, and hooks

- name: Create VFIO directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ install_dir }}"
    - "{{ install_dir }}/lib"
    - "{{ install_dir }}/scripts"
    - "{{ install_dir }}/config"
    - /etc/libvirt/hooks
    - /var/log/libvirt

- name: Copy VFIO library
  copy:
    src: "{{ project_root }}/lib/vfio-common.sh"
    dest: "{{ install_dir }}/lib/vfio-common.sh"
    mode: '0755'
  when: project_root + '/lib/vfio-common.sh' is file

- name: Copy VFIO scripts
  copy:
    src: "{{ item }}"
    dest: "{{ install_dir }}/scripts/{{ item | basename }}"
    mode: '0755'
  loop:
    - "{{ project_root }}/scripts/vfio-start"
    - "{{ project_root }}/scripts/vfio-stop"
  when: item is file

- name: Install libvirt hook
  copy:
    src: "{{ project_root }}/hooks/qemu.new"
    dest: /etc/libvirt/hooks/qemu
    mode: '0755'
  when: project_root + '/hooks/qemu.new' is file

- name: Configure hook to use install directory
  lineinfile:
    path: /etc/libvirt/hooks/qemu
    regexp: '^PROJECT_ROOT='
    line: 'PROJECT_ROOT="{{ install_dir }}"'
    insertafter: '# Determine project root'
  when: project_root + '/hooks/qemu.new' is file

- name: Create libvirt-nosleep service
  copy:
    dest: /etc/systemd/system/libvirt-nosleep@.service
    content: |
      [Unit]
      Description=Preventing sleep while libvirt domain "%i" is running

      [Service]
      Type=simple
      ExecStart=/usr/bin/systemd-inhibit --what=sleep --why="Libvirt domain %i is running" --who=%U --mode=block sleep infinity
    mode: '0644'

- name: Reload systemd
  systemd:
    daemon_reload: true
