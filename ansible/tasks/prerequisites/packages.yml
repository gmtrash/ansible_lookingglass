---
# Package Verification - Check for required packages

- name: Check individual package components
  shell: |
    # Check for QEMU (try both binary names)
    if command -v qemu-system-x86_64 &>/dev/null; then
      echo "qemu: $(command -v qemu-system-x86_64)"
    elif command -v qemu-system-x86 &>/dev/null; then
      echo "qemu: $(command -v qemu-system-x86)"
    else
      echo "qemu: NOT FOUND"
    fi

    echo "virsh: $(command -v virsh || echo 'NOT FOUND')"
    echo "virt-manager: $(command -v virt-manager || echo 'NOT FOUND')"

    # Check for OVMF (multiple possible locations)
    if [ -f /usr/share/OVMF/OVMF_CODE.fd ]; then
      echo "OVMF: /usr/share/OVMF/OVMF_CODE.fd"
    elif [ -f /usr/share/edk2/ovmf/OVMF_CODE.fd ]; then
      echo "OVMF: /usr/share/edk2/ovmf/OVMF_CODE.fd"
    elif [ -f /usr/share/ovmf/OVMF.fd ]; then
      echo "OVMF: /usr/share/ovmf/OVMF.fd"
    elif [ -f /usr/share/qemu/OVMF_CODE.fd ]; then
      echo "OVMF: /usr/share/qemu/OVMF_CODE.fd"
    else
      echo "OVMF: NOT FOUND"
    fi
  register: package_details
  changed_when: false
  failed_when: false
  become: false

- name: Display detailed package check
  debug:
    msg: "{{ package_details.stdout_lines }}"

- name: Check if required packages are installed
  shell: |
    # Check for key packages - works across distros
    # Accept either qemu-system-x86_64 OR qemu-system-x86 (Ubuntu uses latter)
    if (command -v qemu-system-x86_64 &>/dev/null || command -v qemu-system-x86 &>/dev/null) && \
       command -v virsh &>/dev/null && \
       command -v virt-manager &>/dev/null && \
       ([ -f /usr/share/OVMF/OVMF_CODE.fd ] || \
        [ -f /usr/share/edk2/ovmf/OVMF_CODE.fd ] || \
        [ -f /usr/share/ovmf/OVMF.fd ] || \
        [ -f /usr/share/qemu/OVMF_CODE.fd ]); then
      echo "installed"
    else
      echo "missing"
    fi
  register: packages_check
  changed_when: false
  failed_when: false
  become: false

- name: Display package status (all installed)
  debug:
    msg:
      - "✓ All required packages are installed"
  when: "'installed' in packages_check.stdout"

- name: Warn if packages might be missing
  debug:
    msg:
      - "╔════════════════════════════════════════════════════════════╗"
      - "║  PREREQUISITE WARNING: Some packages may be missing       ║"
      - "╚════════════════════════════════════════════════════════════╝"
      - ""
      - "Package check failed. Review the detection above and verify:"
      - ""
      - "Required packages (Ubuntu/Debian):"
      - "  sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients \\"
      - "    virt-manager ovmf bridge-utils dnsmasq dmidecode pciutils"
      - ""
      - "If all packages are actually installed, this may be a false positive."
      - "Continuing anyway - VM creation may fail if packages truly missing."
      - ""
  when: "'missing' in packages_check.stdout"
