---
# Download ISOs - VirtIO drivers and Windows 11

# Note: ISO directory already created by user_preferences.yml

- name: Check if VirtIO ISO exists
  stat:
    path: "{{ virtio_iso }}"
  register: virtio_stat
  become: false

- name: Download VirtIO drivers (user directory)
  get_url:
    url: "https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso"
    dest: "{{ virtio_iso }}"
    mode: '0644'
  when: not virtio_stat.stat.exists and not storage_needs_sudo
  become: false

- name: Recommend downloading VirtIO drivers (system directory)
  debug:
    msg:
      - "VirtIO ISO not found in system directory. Please download manually:"
      - "  sudo curl -L -o {{ virtio_iso }} https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso"
      - "  sudo chmod 644 {{ virtio_iso }}"
      - ""
      - "Or use a user directory by setting VM_STORAGE_DIR to a path you own."
  when: not virtio_stat.stat.exists and storage_needs_sudo

- name: Check if Windows ISO exists
  stat:
    path: "{{ windows_iso }}"
  register: windows_stat

- name: Prompt for Windows 11 ISO
  pause:
    prompt: |

      ┌────────────────────────────────────────────────────────────┐
      │          Windows 11 ISO Required                           │
      └────────────────────────────────────────────────────────────┘

      Windows 11 ISO not found at: {{ windows_iso }}

      Please download Windows 11 ISO:
      1. Visit: https://www.microsoft.com/software-download/windows11
      2. Download the ISO file
      3. Save it to: {{ windows_iso }}

      Or specify a different path with:
        export WINDOWS_ISO=/path/to/your/Win11.iso

      Press Enter when the ISO is ready, or Ctrl+C to abort...
  when: not windows_stat.stat.exists and not skip_iso_download

- name: Check Windows ISO again after prompt
  stat:
    path: "{{ windows_iso }}"
  register: windows_stat_final
  when: not skip_iso_download

- name: Fail if Windows ISO still missing
  fail:
    msg: "Windows 11 ISO not found at {{ windows_iso }}"
  when: not windows_stat_final.stat.exists and not skip_iso_download

- name: Check if unattend ISO exists
  stat:
    path: "{{ unattend_iso }}"
  register: unattend_stat
  when: unattend_iso is defined and unattend_iso != ''

- name: Display unattend ISO info
  debug:
    msg:
      - "╔════════════════════════════════════════════════════════════╗"
      - "║  Unattended Install ISO (Optional)                        ║"
      - "╚════════════════════════════════════════════════════════════╝"
      - ""
      - "Unattend ISO not found at: {{ unattend_iso }}"
      - ""
      - "This ISO contains autounattend.xml for automated Windows setup."
      - "If you have one, place it at: {{ unattend_iso }}"
      - ""
      - "Or specify with: export UNATTEND_ISO=/path/to/unattend.iso"
      - ""
      - "Without it, Windows installation will require manual interaction."
      - "Continuing anyway..."
  when: unattend_iso is defined and unattend_iso != '' and not unattend_stat.stat.exists

- name: Display ISO status
  debug:
    msg:
      - "VirtIO ISO: {{ '✓ Found' if virtio_stat.stat.exists else '✓ Downloaded' }}"
      - "Windows ISO: {{ '✓ Found' if windows_stat.stat.exists else '⚠ Skipped' if skip_iso_download else '✓ Ready' }}"
      - "Unattend ISO: {{ '✓ Found' if (unattend_stat.stat.exists | default(false)) else '⚠ Optional (not found)' }}"
