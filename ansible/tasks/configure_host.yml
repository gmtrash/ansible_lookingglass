---
# Configure Host - Hugepages and system settings

- name: Calculate hugepages count
  set_fact:
    hugepages_needed: "{{ (vm_memory_gb | int * 1024 / 2) | int }}"

- name: Check current hugepages allocation
  shell: cat /proc/sys/vm/nr_hugepages
  register: hugepages_current
  changed_when: false
  become: false

- name: Verify hugepages allocation
  shell: cat /proc/sys/vm/nr_hugepages
  register: hugepages_actual
  changed_when: false
  become: false

- name: Display hugepages status (sufficient)
  debug:
    msg: "✓ Hugepages: {{ hugepages_actual.stdout }} / {{ hugepages_needed }} configured"
  when: hugepages_actual.stdout | int >= hugepages_needed | int

- name: Display hugepages recommendation
  debug:
    msg:
      - "ℹ Hugepages: {{ hugepages_actual.stdout }} / {{ hugepages_needed }} (insufficient but optional)"
      - ""
      - "For better performance, configure hugepages manually:"
      - "  sudo sysctl -w vm.nr_hugepages={{ hugepages_needed }}"
      - "  echo 'vm.nr_hugepages = {{ hugepages_needed }}' | sudo tee -a /etc/sysctl.conf"
      - ""
      - "Hugepages improve performance but VM will work fine without them."
  when: hugepages_actual.stdout | int < hugepages_needed | int
