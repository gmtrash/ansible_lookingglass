---
# User Preferences - Ask user for configuration choices

- name: Get current user
  set_fact:
    actual_user: "{{ ansible_env.USER | default(ansible_user_id) | default(lookup('env', 'USER')) }}"
  become: false

- name: Get actual user home directory
  shell: "eval echo ~{{ actual_user }}"
  register: user_home_cmd
  changed_when: false
  become: false

- name: Set actual home directory
  set_fact:
    actual_home: "{{ user_home_cmd.stdout | trim }}"

- name: Display storage location options
  pause:
    prompt: |

      ┌────────────────────────────────────────────────────────────┐
      │         VM Storage Location Configuration                  │
      └────────────────────────────────────────────────────────────┘

      Where would you like to store VM images and ISOs?

      Options:
        1. {{ actual_home }}/libvirt/images (user directory - no sudo needed)
        2. /var/lib/libvirt/images (system directory - requires sudo)
        3. Custom path

      Enter your choice [1]:
  register: storage_choice
  when: lookup('env', 'VM_STORAGE_DIR') == ''

- name: Set storage directory from choice
  set_fact:
    user_storage_dir: >-
      {%- if storage_choice.user_input == '2' -%}
        /var/lib/libvirt/images
      {%- elif storage_choice.user_input == '3' -%}
        {{ lookup('pipe', 'echo -n "Enter custom path: " >&2 && read path && echo $path') }}
      {%- else -%}
        {{ actual_home }}/libvirt/images
      {%- endif -%}
  when: lookup('env', 'VM_STORAGE_DIR') == '' and storage_choice is defined

- name: Use default storage if no choice made
  set_fact:
    user_storage_dir: "{{ actual_home }}/libvirt/images"
  when: lookup('env', 'VM_STORAGE_DIR') == '' and storage_choice is not defined

- name: Use environment variable if set
  set_fact:
    user_storage_dir: "{{ lookup('env', 'VM_STORAGE_DIR') }}"
  when: lookup('env', 'VM_STORAGE_DIR') != ''

- name: Expand storage directory path
  set_fact:
    iso_dir: "{{ user_storage_dir | expanduser }}"
    virtio_iso: "{{ user_storage_dir | expanduser }}/virtio-win.iso"
    windows_iso: "{{ lookup('env', 'WINDOWS_ISO') if lookup('env', 'WINDOWS_ISO') != '' else (user_storage_dir | expanduser) + '/Win11_23H2.iso' }}"
    unattend_iso: "{{ lookup('env', 'UNATTEND_ISO') if lookup('env', 'UNATTEND_ISO') != '' else (user_storage_dir | expanduser) + '/unattend.iso' }}"

- name: Determine if sudo is needed for storage
  set_fact:
    storage_needs_sudo: "{{ not iso_dir.startswith(actual_home) }}"

- name: Display chosen storage location
  debug:
    msg:
      - "Storage directory: {{ iso_dir }}"
      - "Requires sudo: {{ storage_needs_sudo }}"
      - "Operations will run as: {{ 'root' if storage_needs_sudo else actual_user }}"

- name: Create storage directory (user)
  file:
    path: "{{ iso_dir }}"
    state: directory
    mode: '0755'
  become: false
  when: not storage_needs_sudo

- name: Check if system storage directory exists
  stat:
    path: "{{ iso_dir }}"
  register: system_dir_stat
  when: storage_needs_sudo

- name: Recommend creating system storage directory
  debug:
    msg:
      - "System directory selected but does not exist. Please create it manually:"
      - "  sudo mkdir -p {{ iso_dir }}"
      - "  sudo chmod 755 {{ iso_dir }}"
      - ""
      - "Then re-run this setup script."
  when: storage_needs_sudo and not system_dir_stat.stat.exists

- name: Fail if system directory doesn't exist
  fail:
    msg: "System storage directory {{ iso_dir }} does not exist. See instructions above."
  when: storage_needs_sudo and not system_dir_stat.stat.exists
