---
# User Preferences - Ask user for configuration choices

- name: Get current user
  set_fact:
    actual_user: "{{ ansible_env.USER | default(ansible_user_id) | default(lookup('env', 'USER')) }}"
  become: false

- name: Get actual user home directory
  shell: "eval echo ~{{ actual_user }}"
  register: user_home_cmd
  changed_when: false
  become: false

- name: Set actual home directory
  set_fact:
    actual_home: "{{ user_home_cmd.stdout | trim }}"

- name: Use environment variable if set, otherwise default to user home
  set_fact:
    user_storage_dir: "{{ lookup('env', 'VM_STORAGE_DIR') if lookup('env', 'VM_STORAGE_DIR') != '' else actual_home + '/libvirt/images' }}"

- name: Expand storage directory path
  set_fact:
    iso_dir: "{{ user_storage_dir | expanduser }}"
    virtio_iso: "{{ user_storage_dir | expanduser }}/virtio-win.iso"
    windows_iso: "{{ user_storage_dir | expanduser }}/Win11_23H2.iso"

- name: Display chosen storage location
  debug:
    msg:
      - "Storage directory: {{ iso_dir }}"
      - "User directory (no sudo required)"

- name: Create storage directory
  file:
    path: "{{ iso_dir }}"
    state: directory
    mode: '0755'
