---
# Prerequisites - Check and install required packages

- name: Check individual package components
  shell: |
    echo "qemu-system-x86_64: $(command -v qemu-system-x86_64 || echo 'NOT FOUND')"
    echo "virsh: $(command -v virsh || echo 'NOT FOUND')"
    echo "virt-manager: $(command -v virt-manager || echo 'NOT FOUND')"
    if [ -f /usr/share/OVMF/OVMF_CODE.fd ]; then
      echo "OVMF: /usr/share/OVMF/OVMF_CODE.fd"
    elif [ -f /usr/share/edk2/ovmf/OVMF_CODE.fd ]; then
      echo "OVMF: /usr/share/edk2/ovmf/OVMF_CODE.fd"
    else
      echo "OVMF: NOT FOUND"
    fi
  register: package_details
  changed_when: false
  failed_when: false
  become: false

- name: Display detailed package check
  debug:
    msg: "{{ package_details.stdout_lines }}"

- name: Check if required packages are installed
  shell: |
    # Check for key packages - works across distros
    if command -v qemu-system-x86_64 &>/dev/null && \
       command -v virsh &>/dev/null && \
       command -v virt-manager &>/dev/null && \
       ([ -f /usr/share/OVMF/OVMF_CODE.fd ] || [ -f /usr/share/edk2/ovmf/OVMF_CODE.fd ]); then
      echo "installed"
    else
      echo "missing"
    fi
  register: packages_check
  changed_when: false
  failed_when: false
  become: false

- name: Display package status (all installed)
  debug:
    msg:
      - "✓ All required packages are installed"
  when: "'installed' in packages_check.stdout"

- name: Warn if packages are missing
  debug:
    msg:
      - "╔════════════════════════════════════════════════════════════╗"
      - "║  PREREQUISITE WARNING: Missing Packages                   ║"
      - "╚════════════════════════════════════════════════════════════╝"
      - ""
      - "Some required packages are not installed. Please install them:"
      - ""
      - "Ubuntu/Debian:"
      - "  sudo apt install qemu-kvm libvirt-daemon-system libvirt-clients \\"
      - "    virt-manager ovmf bridge-utils dnsmasq dmidecode pciutils"
      - ""
      - "Fedora/RHEL:"
      - "  sudo dnf install qemu-kvm libvirt virt-install virt-manager \\"
      - "    edk2-ovmf bridge-utils dnsmasq dmidecode pciutils"
      - ""
      - "Arch:"
      - "  sudo pacman -S qemu-base libvirt virt-manager edk2-ovmf \\"
      - "    bridge-utils dnsmasq dmidecode pciutils"
      - ""
      - "After installing, re-run this script."
      - ""
  when: "'missing' in packages_check.stdout"

- name: Fail if packages are missing
  fail:
    msg: "Please install required packages (see above) and re-run setup."
  when: "'missing' in packages_check.stdout"

- name: Check if IOMMU groups exist (reliable non-root check)
  stat:
    path: /sys/kernel/iommu_groups
  register: iommu_groups_dir
  become: false

- name: Count IOMMU groups
  shell: "ls -1 /sys/kernel/iommu_groups/ 2>/dev/null | wc -l"
  register: iommu_group_count
  changed_when: false
  failed_when: false
  become: false

- name: Check kernel command line for IOMMU parameters
  shell: "cat /proc/cmdline"
  register: kernel_cmdline
  changed_when: false
  become: false

- name: Determine IOMMU status
  set_fact:
    iommu_enabled: "{{ iommu_groups_dir.stat.exists and (iommu_group_count.stdout | int > 0) }}"
    iommu_in_cmdline: "{{ 'intel_iommu=on' in kernel_cmdline.stdout or 'amd_iommu=on' in kernel_cmdline.stdout }}"

- name: Display IOMMU status
  debug:
    msg:
      - "IOMMU Groups: {{ iommu_group_count.stdout | default('0') }} found"
      - "IOMMU Status: {{ 'ENABLED ✓' if iommu_enabled else 'NOT DETECTED ✗' }}"
      - "Kernel cmdline: {{ 'IOMMU parameters present ✓' if iommu_in_cmdline else 'No IOMMU parameters found' }}"

- name: Warn if IOMMU not detected
  pause:
    prompt: |
      WARNING: IOMMU does not appear to be enabled!

      IOMMU groups found: {{ iommu_group_count.stdout | default('0') }}
      Kernel parameters: {{ 'Found' if iommu_in_cmdline else 'Missing' }}

      To enable IOMMU:
      1. Edit /etc/default/grub
      2. Add to GRUB_CMDLINE_LINUX_DEFAULT:
         - For Intel: intel_iommu=on iommu=pt
         - For AMD: amd_iommu=on iommu=pt
      3. Run: sudo update-grub (or grub2-mkconfig -o /boot/grub2/grub.cfg)
      4. Reboot

      Press Ctrl+C to abort, or Enter to continue anyway...
  when: not iommu_enabled

- name: Check if libvirtd is running
  shell: systemctl is-active libvirtd
  register: libvirtd_status
  failed_when: false
  changed_when: false
  become: false

- name: Display libvirtd status (running)
  debug:
    msg: "✓ libvirtd service is running"
  when: libvirtd_status.rc == 0

- name: Warn if libvirtd not running
  debug:
    msg:
      - "⚠ libvirtd service is not running"
      - ""
      - "Start and enable libvirtd:"
      - "  sudo systemctl start libvirtd"
      - "  sudo systemctl enable libvirtd"
  when: libvirtd_status.rc != 0

- name: Check current user's group membership
  shell: groups "{{ ansible_env.USER | default(ansible_user_id) }}"
  register: user_groups
  changed_when: false
  become: false

- name: Display group membership status (OK)
  debug:
    msg: "✓ User '{{ ansible_env.USER }}' is in libvirt and kvm groups"
  when: "'libvirt' in user_groups.stdout and 'kvm' in user_groups.stdout"

- name: Recommend adding user to groups
  debug:
    msg:
      - "⚠ User '{{ ansible_env.USER }}' is not in required groups"
      - ""
      - "Add yourself to libvirt and kvm groups:"
      - "  sudo usermod -aG libvirt,kvm {{ ansible_env.USER }}"
      - "  newgrp libvirt"
      - ""
      - "(You may need to log out and back in for group changes to take effect)"
  when: "'libvirt' not in user_groups.stdout or 'kvm' not in user_groups.stdout"
