---
- name: Setup Looking Glass VFIO VM on Linux Host
  hosts: vfio-host
  become: true
  vars:
    project_root: "{{ playbook_dir | dirname }}"
    install_dir: /usr/local/share/vfio-setup

  tasks:
    - name: Install required packages
      package:
        name:
          - qemu-kvm
          - libvirt
          - virt-manager
          - ovmf
          - bridge-utils
          - dnsmasq
        state: present

    - name: Create project directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ install_dir }}"
        - "{{ install_dir }}/lib"
        - "{{ install_dir }}/scripts"
        - "{{ install_dir }}/config"
        - /etc/libvirt/hooks
        - /var/log/libvirt

    - name: Copy library functions
      copy:
        src: "{{ project_root }}/lib/vfio-common.sh"
        dest: "{{ install_dir }}/lib/vfio-common.sh"
        mode: '0755'

    - name: Copy scripts
      copy:
        src: "{{ item }}"
        dest: "{{ install_dir }}/scripts/{{ item | basename }}"
        mode: '0755'
      loop:
        - "{{ project_root }}/scripts/vfio-start"
        - "{{ project_root }}/scripts/vfio-stop"

    - name: Generate configuration file
      template:
        src: vfio.conf.j2
        dest: "{{ install_dir }}/config/vfio.conf"
        mode: '0644'

    - name: Install libvirt hook
      copy:
        src: "{{ project_root }}/hooks/qemu.new"
        dest: /etc/libvirt/hooks/qemu
        mode: '0755'

    - name: Configure hook to use install directory
      lineinfile:
        path: /etc/libvirt/hooks/qemu
        regexp: '^PROJECT_ROOT='
        line: 'PROJECT_ROOT="{{ install_dir }}"'
        insertafter: '# Determine project root'

    - name: Create libvirt-nosleep service
      copy:
        dest: /etc/systemd/system/libvirt-nosleep@.service
        content: |
          [Unit]
          Description=Preventing sleep while libvirt domain "%i" is running

          [Service]
          Type=simple
          ExecStart=/usr/bin/systemd-inhibit --what=sleep --why="Libvirt domain %i is running" --who=%U --mode=block sleep infinity
        mode: '0644'

    - name: Reload systemd
      systemd:
        daemon_reload: true

    - name: Check IOMMU in kernel command line
      shell: cat /proc/cmdline
      register: cmdline
      changed_when: false

    - name: Warn if IOMMU not enabled
      debug:
        msg: "WARNING: IOMMU may not be enabled. Add 'intel_iommu=on' or 'amd_iommu=on' to kernel parameters"
      when: >
        'intel_iommu=on' not in cmdline.stdout and
        'amd_iommu=on' not in cmdline.stdout

    - name: Configure hugepages
      when: enable_hugepages | default(false)
      block:
        - name: Create hugepages mount point
          file:
            path: /dev/hugepages
            state: directory
            mode: '0755'

        - name: Add hugepages to fstab
          mount:
            path: /dev/hugepages
            src: hugetlbfs
            fstype: hugetlbfs
            opts: mode=1770,gid={{ host_username }}
            state: present

    - name: Setup bridge network
      when: bridge_interface is defined
      block:
        - name: Check if NetworkManager is active
          systemd:
            name: NetworkManager
          register: nm_status
          failed_when: false

        - name: Create bridge with nmcli (NetworkManager)
          when: nm_status.status.ActiveState == "active"
          shell: |
            nmcli connection show {{ bridge_name }} || \
            nmcli connection add type bridge ifname {{ bridge_name }} con-name {{ bridge_name }}
            nmcli connection show bridge-{{ bridge_interface }} || \
            nmcli connection add type bridge-slave ifname {{ bridge_interface }} master {{ bridge_name }}
          register: nm_bridge
          changed_when: "'successfully added' in nm_bridge.stdout"

    - name: Setup Looking Glass shared memory (KVMFR)
      when: use_kvmfr_module | default(false)
      block:
        - name: Install Looking Glass KVMFR module files
          copy:
            dest: /etc/modules-load.d/kvmfr.conf
            content: kvmfr
            mode: '0644'

        - name: Create Looking Glass udev rules
          copy:
            dest: /etc/udev/rules.d/99-kvmfr.rules
            content: |
              SUBSYSTEM=="kvmfr", OWNER="{{ host_username }}", GROUP="kvm", MODE="0660"
            mode: '0644'

        - name: Create kvmfr module options
          copy:
            dest: /etc/modprobe.d/kvmfr.conf
            content: |
              options kvmfr static_size_mb={{ looking_glass_size_mb }}
            mode: '0644'

    - name: Generate VM XML configuration
      template:
        src: vm-config.xml.j2
        dest: "{{ install_dir }}/{{ vm_name }}.xml"
        mode: '0644'

    - name: Add user to required groups
      user:
        name: "{{ host_username }}"
        groups: libvirt,kvm,input
        append: true

    - name: Display next steps
      debug:
        msg:
          - "=========================================="
          - "VFIO Setup Complete!"
          - "=========================================="
          - ""
          - "Next steps:"
          - "1. Reboot to ensure all changes take effect"
          - "2. Verify IOMMU groups: {{ install_dir }}/scripts/find_iommu.sh"
          - "3. Create/import Windows 11 disk image"
          - "4. Define the VM: virsh define {{ install_dir }}/{{ vm_name }}.xml"
          - "5. Start the VM: virsh start {{ vm_name }}"
          - ""
          - "Configuration:"
          - "  - Config file: {{ install_dir }}/config/vfio.conf"
          - "  - VM XML: {{ install_dir }}/{{ vm_name }}.xml"
          - "  - Logs: /var/log/libvirt/vfio.log"
          - ""
          - "Libvirt hooks installed - VM will automatically:"
          - "  - Stop display manager on start"
          - "  - Unload GPU drivers"
          - "  - Load VFIO drivers"
          - "  - Restore everything on shutdown"
          - "=========================================="
