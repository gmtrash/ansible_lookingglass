---
- name: Setup Looking Glass VFIO VM on Linux Host
  hosts: vfio-host
  become: false
  vars:
    project_root: "{{ playbook_dir | dirname }}"
    install_dir: "{{ lookup('env', 'HOME') }}/.local/share/vfio-setup"

  tasks:
    - name: Install required packages
      package:
        name:
          - qemu-kvm
          - libvirt
          - virt-manager
          - ovmf
          - bridge-utils
          - dnsmasq
        state: present

    - name: Create project directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ install_dir }}"
        - "{{ install_dir }}/lib"
        - "{{ install_dir }}/scripts"
        - "{{ install_dir }}/config"
        - /etc/libvirt/hooks
        - /var/log/libvirt

    - name: Copy library functions
      copy:
        src: "{{ project_root }}/lib/vfio-common.sh"
        dest: "{{ install_dir }}/lib/vfio-common.sh"
        mode: '0755'

    - name: Copy scripts
      copy:
        src: "{{ item }}"
        dest: "{{ install_dir }}/scripts/{{ item | basename }}"
        mode: '0755'
      loop:
        - "{{ project_root }}/scripts/vfio-start"
        - "{{ project_root }}/scripts/vfio-stop"

    - name: Generate configuration file
      template:
        src: vfio.conf.j2
        dest: "{{ install_dir }}/config/vfio.conf"
        mode: '0644'

    - name: Install libvirt hook
      copy:
        src: "{{ project_root }}/hooks/qemu.new"
        dest: /etc/libvirt/hooks/qemu
        mode: '0755'

    - name: Configure hook to use install directory
      lineinfile:
        path: /etc/libvirt/hooks/qemu
        regexp: '^PROJECT_ROOT='
        line: 'PROJECT_ROOT="{{ install_dir }}"'
        insertafter: '# Determine project root'

    - name: Create libvirt-nosleep service
      copy:
        dest: /etc/systemd/system/libvirt-nosleep@.service
        content: |
          [Unit]
          Description=Preventing sleep while libvirt domain "%i" is running

          [Service]
          Type=simple
          ExecStart=/usr/bin/systemd-inhibit --what=sleep --why="Libvirt domain %i is running" --who=%U --mode=block sleep infinity
        mode: '0644'

    - name: Reload systemd
      systemd:
        daemon_reload: true

    - name: Check IOMMU in kernel command line
      shell: cat /proc/cmdline
      register: cmdline
      changed_when: false

    - name: Warn if IOMMU not enabled
      debug:
        msg: "WARNING: IOMMU may not be enabled. Add 'intel_iommu=on' or 'amd_iommu=on' to kernel parameters"
      when: >
        'intel_iommu=on' not in cmdline.stdout and
        'amd_iommu=on' not in cmdline.stdout

    - name: Configure hugepages
      when: enable_hugepages | default(false)
      block:
        - name: Create hugepages mount point
          file:
            path: /dev/hugepages
            state: directory
            mode: '0755'

        - name: Add hugepages to fstab
          mount:
            path: /dev/hugepages
            src: hugetlbfs
            fstype: hugetlbfs
            opts: mode=1770,gid={{ host_username }}
            state: present

    - name: Setup bridge network
      when: bridge_interface is defined
      block:
        - name: Check if NetworkManager is active
          systemd:
            name: NetworkManager
          register: nm_status
          failed_when: false

        - name: Create bridge with nmcli (NetworkManager)
          when: nm_status.status.ActiveState == "active"
          shell: |
            nmcli connection show {{ bridge_name }} || \
            nmcli connection add type bridge ifname {{ bridge_name }} con-name {{ bridge_name }}
            nmcli connection show bridge-{{ bridge_interface }} || \
            nmcli connection add type bridge-slave ifname {{ bridge_interface }} master {{ bridge_name }}
          register: nm_bridge
          changed_when: "'successfully added' in nm_bridge.stdout"

    - name: Setup Looking Glass shared memory (KVMFR)
      when: use_kvmfr_module | default(false)
      block:
        - name: Install Looking Glass KVMFR module files
          copy:
            dest: /etc/modules-load.d/kvmfr.conf
            content: kvmfr
            mode: '0644'

        - name: Create Looking Glass udev rules
          copy:
            dest: /etc/udev/rules.d/99-kvmfr.rules
            content: |
              SUBSYSTEM=="kvmfr", OWNER="{{ host_username }}", GROUP="kvm", MODE="0660"
            mode: '0644'

        - name: Create kvmfr module options
          copy:
            dest: /etc/modprobe.d/kvmfr.conf
            content: |
              options kvmfr static_size_mb={{ looking_glass_size_mb }}
            mode: '0644'

    - name: Generate VM XML configuration
      template:
        src: vm-config.xml.j2
        dest: "{{ install_dir }}/{{ vm_name }}.xml"
        mode: '0644'

    - name: Add user to required groups
      user:
        name: "{{ host_username }}"
        groups: libvirt,kvm,input
        append: true

    - name: Detect host SMBIOS information (for VM evasion)
      block:
        - name: Get BIOS information
          shell: |
            dmidecode -t bios | grep -E 'Vendor|Version|Release Date' | head -3
          register: bios_info
          changed_when: false
          failed_when: false

        - name: Get System information
          shell: |
            dmidecode -t system | grep -E 'Manufacturer|Product Name|Version|Serial Number|SKU Number|Family' | head -6
          register: system_info
          changed_when: false
          failed_when: false

        - name: Get Baseboard information
          shell: |
            dmidecode -t baseboard | grep -E 'Manufacturer|Product Name|Version|Serial Number|Asset Tag|Location In Chassis' | head -6
          register: baseboard_info
          changed_when: false
          failed_when: false

        - name: Save SMBIOS info for reference
          copy:
            dest: "{{ install_dir }}/config/host_smbios_info.txt"
            content: |
              # Host SMBIOS Information
              # Use these values in inventory.yml for better VM detection evasion

              # BIOS Information (Type 0):
              {{ bios_info.stdout }}

              # System Information (Type 1):
              {{ system_info.stdout }}

              # Baseboard Information (Type 2):
              {{ baseboard_info.stdout }}

              # To use these values, add them to your inventory.yml file:
              # smbios_bios_vendor: "..."
              # smbios_bios_version: "..."
              # smbios_bios_date: "..."
              # smbios_system_manufacturer: "..."
              # smbios_system_product: "..."
              # smbios_system_version: "..."
              # smbios_system_serial: "..."
              # smbios_system_sku: "..."
              # smbios_system_family: "..."
              # smbios_baseboard_manufacturer: "..."
              # smbios_baseboard_product: "..."
              # smbios_baseboard_version: "..."
              # smbios_baseboard_serial: "..."
              # smbios_baseboard_asset: "..."
              # smbios_baseboard_location: "..."
            mode: '0644'
          when: bios_info.rc == 0

    - name: Display next steps
      debug:
        msg:
          - "=========================================="
          - "VFIO Setup Complete!"
          - "=========================================="
          - ""
          - "LINUX HOST - Next Steps:"
          - "========================"
          - "1. Reboot to ensure all changes take effect"
          - "   sudo reboot"
          - ""
          - "2. After reboot, verify IOMMU is enabled:"
          - "   dmesg | grep -i iommu"
          - ""
          - "3. Create Windows 11 disk image:"
          - "   sudo qemu-img create -f qcow2 {{ vm_disk_path | default('/var/lib/libvirt/images/win11.qcow2') }} 120G"
          - ""
          - "4. Define the VM:"
          - "   sudo virsh define {{ install_dir }}/{{ vm_name }}.xml"
          - ""
          - "5. Start the VM and install Windows 11:"
          - "   virsh start {{ vm_name }}"
          - "   virt-manager  # Use GUI to see display during install"
          - ""
          - "6. Install Looking Glass CLIENT on Linux:"
          - "   sudo apt install looking-glass-client    # Ubuntu/Debian"
          - "   sudo dnf install looking-glass-client    # Fedora"
          - ""
          - "=========================================="
          - "WINDOWS GUEST - Setup Instructions:"
          - "=========================================="
          - ""
          - "After Windows 11 is installed in the VM:"
          - ""
          - "1. Install GPU drivers (NVIDIA/AMD)"
          - ""
          - "2. Download Looking Glass HOST from:"
          - "   https://looking-glass.io/downloads"
          - ""
          - "3. Install IVSHMEM driver:"
          - "   - Open Device Manager"
          - "   - Find 'PCI standard RAM Controller'"
          - "   - Update driver → Browse → Point to IVSHMEM driver folder"
          - ""
          - "4. Run Looking Glass Host installer:"
          - "   - looking-glass-host-setup-B6.exe"
          - "   - CHECK 'Install as Service'"
          - ""
          - "5. Configure Looking Glass Host:"
          - "   Create: C:\\ProgramData\\Looking Glass (host)\\looking-glass-host.ini"
          - "   [app]"
          - "   shmFile=looking-glass"
          - "   [capture]"
          - "   captureAPI=DXGI"
          - "   [audio]"
          - "   enabled=true"
          - ""
          - "6. Reboot Windows or start service manually:"
          - "   Win+R → services.msc → Find 'Looking Glass (host)' → Start"
          - ""
          - "=========================================="
          - "USAGE:"
          - "=========================================="
          - ""
          - "Start VM:     virsh start {{ vm_name }}"
          - "Stop VM:      virsh shutdown {{ vm_name }}"
          - "View display: looking-glass-client -F"
          - ""
          - "Key shortcuts in Looking Glass:"
          - "  Scroll Lock       - Capture/release input"
          - "  Scroll Lock + Q   - Quit"
          - "  Scroll Lock + F   - Toggle fullscreen"
          - "  Scroll Lock + I   - Show FPS/latency"
          - ""
          - "=========================================="
          - "Configuration Files:"
          - "=========================================="
          - "  Config:  {{ install_dir }}/config/vfio.conf"
          - "  VM XML:  {{ install_dir }}/{{ vm_name }}.xml"
          - "  Logs:    /var/log/libvirt/vfio.log"
          - ""
          - "Libvirt hooks will automatically:"
          - "  ✓ Stop display manager on VM start"
          - "  ✓ Unload GPU drivers"
          - "  ✓ Load VFIO drivers"
          - "  ✓ Allocate hugepages"
          - "  ✓ Restore everything on VM shutdown"
          - ""
          - "=========================================="
          - "VM Detection Evasion:"
          - "=========================================="
          - ""
          - "Your SMBIOS info saved to:"
          - "  {{ install_dir }}/config/host_smbios_info.txt"
          - ""
          - "To avoid anti-cheat detection:"
          - "  1. Use your real motherboard SMBIOS values"
          - "  2. Avoid VM vendor MAC addresses (52:54:00, etc.)"
          - "  3. Test with Pafish or Al-Khaser tools"
          - ""
          - "Full VM evasion guide:"
          - "  {{ playbook_dir | dirname }}/docs/VM_DETECTION_EVASION.md"
          - ""
          - "Full documentation: {{ playbook_dir | dirname }}/README.md"
          - "=========================================="
